import { consume } from '@lit/context';
import { html, LitElement, nothing } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import type { GlCommands } from '../../../../constants.commands.js';
import { SubscriptionState } from '../../../../constants.subscription.js';
import { ExecuteCommand } from '../../../protocol.js';
import type { State } from '../../../welcome/protocol.js';
import { scrollableBase } from '../../shared/components/styles/lit/base.css.js';
import { ipcContext } from '../../shared/contexts/ipc.js';
import type { TelemetryContext } from '../../shared/contexts/telemetry.js';
import { telemetryContext } from '../../shared/contexts/telemetry.js';
import { stateContext } from '../../welcome/context.js';
import { welcomeStyles } from './welcome-page.css.js';
import '../../shared/components/gitlens-logo-circle.js';
import '../../shared/components/button.js';
import '../../shared/components/code-icon.js';
import './welcome-parts.js';
import type { WalkthroughStep } from './welcome-parts.js';

declare global {
	interface HTMLElementTagNameMap {
		'gl-welcome-page': GlWelcomePage;
	}
}

type TelemetryData = {
	viewedCarouselPages: number;
	proButtonClicked: boolean;
};

const walkthroughSteps: WalkthroughStep[] = [
	{
		id: 'get-started-community',
		walkthroughKey: 'gettingStarted',
		title: 'Welcome to GitLens: Unlock Your Repo’s Full Story',
		body: html`
			<p>The Community Edition lets you:</p>
			<ul>
				<li>View blame annotations and commit details inline</li>
				<li>Explore file revision history for any repo</li>
			</ul>
			<p>
				Upgrade to <strong>GitLens Pro</strong> (Free 14-Day Trial) to access everything above plus advanced
				visualization, collaboration, and built-in AI tools that work right inside VS Code.
			</p>
			<p><code-icon class="icon" icon="sparkle"></code-icon> Pro gives you full access to:</p>
			<ul>
				<li><strong>Commit Graph:</strong> visualize every branch and commit relationship</li>
				<li>
					<strong>Visual File History:</strong> see how a file has evolved with a graph of what changed and
					when
				</li>
				<li><strong>Launchpad & Worktrees:</strong> manage PRs and branches in one hub</li>
				<li><strong>GitKraken AI:</strong> writes commits, PRs & changelogs for you.</li>
			</ul>
			<div>
				<gl-button class="start-trial-button" href="command:gitlens.walkthrough.plus.signUp"
					>Get Started with GitLens Pro</gl-button
				>
			</div>
			<p>or <a href="command:gitlens.walkthrough.plus.login">sign in</a></p>
		`,
		condition: plusState => !plusState || plusState < SubscriptionState.Trial,
	},

	{
		id: 'welcome-in-trial',
		walkthroughKey: 'gettingStarted',
		title: 'Welcome to GitLens Pro',
		body: html`
			<p>Thanks for starting your <strong>GitLens Pro</strong> trial.</p>
			<p>
				Complete this walkthrough to experience enhanced PR review tools, deeper code history visualizations,
				and streamlined collaboration to help boost your productivity.
			</p>
			<a href="command:gitlens.walkthrough.openWalkthrough">Continue the Walkthrough</a>
			<p>
				Once your trial ends, you'll return to <strong>GitLens Community</strong> — where you can still leverage
				features like in-editor blame annotations, hovers, CodeLens, and more.
			</p>
			<div>
				<gl-button class="start-trial-button" href="command:gitlens.walkthrough.plus.upgrade"
					>Upgrade to GitLens Pro</gl-button
				>
			</div>
		`,
		condition: plusState => plusState === SubscriptionState.Trial,
	},

	{
		id: 'welcome-in-trial-expired',
		walkthroughKey: 'gettingStarted',
		title: 'Get the most out of GitLens',
		body: html`
			<p>Thanks for installing GitLens and trying out GitLens Pro.</p>
			<p>
				You're now on the <strong>GitLens Community</strong> edition. Track code changes and see who made them
				with features like in-editor blame annotations, hovers, CodeLens, and more—completely free.
			</p>
			<p>
				Learn more about the
				<a href="command:gitlens.walkthrough.openCommunityVsPro">difference between GitLens Community vs. Pro</a
				>.
			</p>
			<p><strong>Unlock more powerful tools with GitLens Pro</strong></p>
			<div>
				<gl-button class="start-trial-button" href="command:gitlens.walkthrough.plus.upgrade"
					>Upgrade to GitLens Pro</gl-button
				>
			</div>
			<p>
				With GitLens Pro, you can accelerate PR reviews, visualize code history in-depth, and enhance
				collaboration across your team. It's the perfect upgrade to streamline your VS Code workflow.
			</p>
		`,
		condition: plusState => plusState === SubscriptionState.TrialExpired,
	},

	{
		id: 'welcome-in-trial-expired-eligible',
		walkthroughKey: 'gettingStarted',
		title: 'Get the most out of GitLens',
		body: html`
			<p>Thanks for installing GitLens and trying out GitLens Pro.</p>
			<p>
				You're using <strong>GitLens Community</strong> edition. Track code changes and see who made them with
				features like in-editor blame annotations, hovers, CodeLens, and more—completely free.
			</p>
			<p><strong>Unlock more powerful tools — Try GitLens Pro again</strong> free for another 14 days.</p>
			<div>
				<gl-button class="start-trial-button" href="command:gitlens.walkthrough.plus.reactivate"
					>Reactivate GitLens Pro Trial</gl-button
				>
			</div>
			<p>
				With GitLens Pro, you can accelerate PR reviews, visualize code history in-depth, and enhance
				collaboration across your team. It's the perfect upgrade to streamline your VS Code workflow.
			</p>
		`,
		condition: plusState => plusState === SubscriptionState.TrialReactivationEligible,
	},

	{
		id: 'welcome-paid',
		walkthroughKey: 'gettingStarted',
		title: 'Discover the Benefits of GitLens Pro',
		body: html`
			<p>
				As a <strong>GitLens Pro</strong> user, you have access to powerful tools that accelerate PR reviews,
				provide deeper code history visualizations, and streamline collaboration across your team.
			</p>
			<div>
				<gl-button href="command:gitlens.walkthrough.openWalkthrough">Continue the Walkthrough</gl-button>
			</div>
			<p>
				<em>Tip:</em> To get the most out of your <strong>GitLens Pro</strong> experience, complete the
				walkthrough and visit our Help Center for in-depth guides.
			</p>
			<a href="command:gitlens.walkthrough.openHelpCenter">Learn more in the Help Center</a>
		`,
		condition: plusState => plusState === SubscriptionState.Paid,
	},

	{
		id: 'visualize-code-history',
		walkthroughKey: 'visualizeCodeHistory',
		title: "See Your Code's Story: Commit Graph",
		body: html`
			<p>
				Navigate complex repositories with a searchable, color-coded commit timeline. Instantly understand
				branch relationships, authorship patterns, and commit sequences.
			</p>
			<p>
				Select multiple commits to batch operations like cherry-picking or generate AI changelogs with a single
				command.
			</p>
			<div><gl-button href="command:gitlens.walkthrough.showGraph">Discover your Commit Graph</gl-button></div>
		`,
	},

	{
		id: 'ai-features',
		walkthroughKey: 'aiFeatures',
		title: 'Commit smarter, not harder',
		body: html`
			<p>
				Let <strong>GitKraken AI</strong> turn your changes into clear, logical commits - making reviews
				efficient and keeping your commit history clean.
			</p>
			<ul>
				<li>
					<strong>Auto-Compose Commits:</strong> instantly generate a sequence of commits with descriptive
					summaries in an interactive editor
				</li>
				<li>
					<strong>Explain Commits and Branches:</strong> understand changes without wasting time diving into
					the diffs
				</li>
				<li><strong>Create PR Titles & Descriptions:</strong> save reviewers 10+ minutes per review</li>
			</ul>
			<p>Stay in control - review and edit before committing.</p>
			<p>See how effortless documenting your work can be, all without leaving VS Code.</p>
			<div><gl-button href="command:gitlens.walkthrough.showComposer">Compose Commits with AI</gl-button></div>
		`,
	},

	{
		id: 'git-blame',
		walkthroughKey: 'gitBlame',
		title: 'Learn the Why Behind Every Line with Inline Blame',
		body: html`
			<p>See who changed a line, when and why — without leaving your editor. Hover over blame annotations to:</p>
			<ul>
				<li>View previous file revisions</li>
				<li>Open related PRs</li>
				<li>Jump to commits in the Graph</li>
				<li>Compare with previous versions</li>
			</ul>
			<div>
				<gl-button href="command:gitlens.showSettingsPage!current-line">Configure Inline Blame</gl-button>
			</div>
		`,
	},

	{
		id: 'accelerate-pr-reviews',
		walkthroughKey: 'prReviews',
		title: 'Stay in Flow, Manage All Your Work in One Place',
		body: html`
			<p>Keep everything at your fingertips with Launchpad & Worktrees.</p>
			<ul>
				<li><strong>Launchpad:</strong> view and manage all your PRs and branches from one hub</li>
				<li><strong>Worktrees:</strong> code, test, and review on multiple branches in parallel</li>
				<li>
					<strong>Integrations:</strong> connect PRs and issues from GitHub, GitLab, Jira, Azure DevOps & more
				</li>
			</ul>
			<p>Stay in flow, ship faster, and never lose track of what matters.</p>
			<div><gl-button href="command:gitlens.walkthrough.showLaunchpad">Open Launchpad</gl-button></div>
		`,
	},
];

@customElement('gl-welcome-page')
export class GlWelcomePage extends LitElement {
	static override styles = [scrollableBase, welcomeStyles];

	private telemetryData: TelemetryData = {
		viewedCarouselPages: 0,
		proButtonClicked: false,
	};

	@property({ type: Boolean })
	closeable = false;

	@property({ type: String })
	webroot?: string;

	@property({ type: Boolean })
	private isLightTheme = false;

	@consume<State>({ context: stateContext, subscribe: true })
	@state()
	private _state!: State;

	@consume({ context: ipcContext })
	_ipc!: typeof ipcContext.__context__;

	@consume({ context: telemetryContext as { __context__: TelemetryContext } })
	_telemetry!: TelemetryContext;

	override connectedCallback(): void {
		super.connectedCallback?.();
		this._telemetry.sendEvent({
			name: 'welcome/action',
			data: {
				name: 'shown',
			},
			source: { source: 'welcome' },
		});
	}

	private onStartTrial() {
		this.telemetryData.proButtonClicked = true;
		const command: GlCommands = 'gitlens.plus.signUp';
		this._telemetry.sendEvent({
			name: 'welcome/action',
			data: {
				name: 'plus/sign-up',
				viewedCarouselPages: this.telemetryData.viewedCarouselPages,
			},
			source: { source: 'welcome' },
		});
		this._ipc.sendCommand(ExecuteCommand, { command: command, args: [{ source: 'welcome' }] });
	}

	private onClose() {
		this._telemetry.sendEvent({
			name: 'welcome/action',
			data: {
				name: 'dismiss',
				viewedCarouselPages: this.telemetryData.viewedCarouselPages,
				proButtonClicked: this.telemetryData.proButtonClicked,
			},
			source: { source: 'welcome', detail: 'dismiss-in-body' },
		});
		this.dispatchEvent(new CustomEvent('close'));
	}

	private onFeatureAppeared() {
		this.telemetryData.viewedCarouselPages++;
	}

	getTelemetryData(): TelemetryData {
		return { ...this.telemetryData };
	}

	override render(): unknown {
		if (!this._state) return nothing;

		return html`
			<div part="page" class="welcome scrollable">
				<div class="section header">
					<h1><gitlens-logo-circle></gitlens-logo-circle><span>Get Started with GitLens</span></h1>
					<p>
						Supercharge Git and unlock untapped knowledge within your repo to better understand, write, and
						review code.
					</p>
				</div>
				<div class="section">
					<hr />
					<p>3/5 steps complete</p>
				</div>
				<gl-walkthrough class="section">
					${walkthroughSteps
						.filter(step => !step.condition || step.condition(this._state.plusState))
						.map(
							step => html`
								<gl-walkthrough-step
									class="card"
									stepId=${step.id}
									.completed=${step.walkthroughKey != null &&
									this._state.walkthroughProgress?.state[step.walkthroughKey] === true}
								>
									<h1 slot="title">${step.title}</h1>
									${step.body}
								</gl-walkthrough-step>
							`,
						)}
				</gl-walkthrough>
				<div class="section section--centered">
					<p>
						You also have access to the GitKraken DevEx platform, unleashing powerful Git visualization &
						productivity capabilities everywhere you work: IDE, desktop, browser, and terminal.
					</p>
				</div>
			</div>
		`;
	}
}
